<div class="dashboard-container">
  <div class="dashboard-content">
    <!-- ===================== Dashboard Header ===================== -->
    <div class="dashboard-content-section">
      <div class="section-header">
        <h2>EVENTS</h2>
        <!-- Filter Buttons -->
        <div class="filters">
          <button
            [class.active]="selectedFilter === 'CLOSED'"
            (click)="setFilter('CLOSED')"
          >
            CLOSED
          </button>
          <button
            [class.active]="selectedFilter === 'PENDING'"
            (click)="setFilter('PENDING')"
          >
            PENDING
          </button>
        </div>
      </div>

      <!-- ===================== LOADER OVERLAY ===================== -->
      <div class="loader-overlay" *ngIf="isLoading">
        <div class="spinner"></div>
        <p class="font-Neometric-Medium">Loading data...</p>
      </div>

      <!-- ===================== Calendar & Toggles Section ===================== -->
      <div class="calender-section-body">
        <!-- Calendar / DateTime -->
        <div class="calendar-section-wrapper calender-first-section">
          <!-- Show Calendar if CLOSED -->
          <app-calendar
            *ngIf="selectedFilter === 'CLOSED'"
            variant="events"
            (dateRangeSelected)="onDateRangeSelected($event)"
          ></app-calendar>
                  
          <div class="select-wrapper">
          <select
            class="custom-select"
            [(ngModel)]="timeZone"
            (ngModelChange)="timezonechange()"
          >
            <option value="">All</option>
            @for (item of timezones; track item.id) {
            <option [value]="item.timezoneCode" [title]="item.timezoneValue">
              {{ item.timezoneCode }}
            </option>
            }
          </select>
        </div>

          <!-- Show current datetime if PENDING -->
          <div *ngIf="selectedFilter === 'PENDING'" class="current-datetime">
            {{ currentDateTime | date : "dd MMM, yyyy HH:mm " | uppercase }}
          </div>
        </div>

        <!-- Toggle Switches based on selected filter -->
        <div class="escalated-section calender-second-section">
          <!-- CLOSED filter toggles -->
          <div class="filter" *ngIf="selectedFilter === 'CLOSED'">
            <div class="filter-item">
              <h3 class="filters-title">SUSPICIOUS</h3>
              <label class="switch">
                <input
                  type="checkbox"
                  name="closedSuspicious"
                  [(ngModel)]="suspiciousChecked"
                  (change)="onClosedTogglesChanged()"
                />
                <span class="slider round"></span>
              </label>
            </div>

            <div class="filter-item">
              <h3 class="filters-title">FALSE</h3>
              <label class="switch">
                <input
                  type="checkbox"
                  name="closedFalse"
                  [(ngModel)]="falseChecked"
                  (change)="onClosedTogglesChanged()"
                />
                <span class="slider round"></span>
              </label>
            </div>
          </div>

          <!-- PENDING filter toggles -->
          <div class="filter" *ngIf="selectedFilter === 'PENDING'">
            <div class="filter-item">
              <h3 class="filters-title">CONSOLES</h3>
              <label class="switch">
                <input
                  type="checkbox"
                  name="pendingConsoles"
                  [(ngModel)]="consolesChecked"
                  (change)="onPendingTogglesChanged()"
                />
                <span class="slider round"></span>
              </label>
            </div>

            <div class="filter-item">
              <h3 class="filters-title">QUEUES</h3>
              <label class="switch">
                <input
                  type="checkbox"
                  name="pendingQueues"
                  [(ngModel)]="queuesChecked"
                  (change)="onPendingTogglesChanged()"
                />
                <span class="slider round"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- ===================== Right-side ESCALATION Popup ===================== -->
        <div class="right-tablepopup" *ngIf="isTablePopupVisible">
          <div class="popup-header">
            <div class="popup-header-content">
              <img
                *ngIf="selectedItem?.iconPath"
                [src]="selectedItem.iconPath"
                alt="icon"
              />
              <div class="icon-info">
                <p class="label">ESCALATION DETAILS</p>
              </div>
            </div>
            <button class="close-btn" (click)="closePopup()">×</button>
          </div>

          <div class="popup-body">
            <div class="escalated-content-section">
              <app-escalation-popup
                [isVisible]="isTablePopupVisible"
                [selectedItem]="selectedItem"
                [selectedDate]="selectedDate"
                (close)="closePopup()"
                (refreshMoreInfo)="onRefreshMoreInfo($event)"
                (addCommentClicked)="openAddCommentPopup()"
              ></app-escalation-popup>
            </div>
          </div>
        </div>

        <!-- ===================== Right-side ADD COMMENT Popup ===================== -->
        <div class="comment-right-tablepopup" *ngIf="isAddCommentPopupVisible">
          <div class="comment-popup-header add-comment-header">
            <div class="popup-header-content">
              <!-- back arrow -->
              <button class="circle-icon-btn" (click)="cancelAddComment()">
                ←
              </button>
              <div class="icon-info">
                <p class="label">ADD COMMENT</p>
              </div>
            </div>

            <!-- close X -->
            <button class="close-btn" (click)="cancelAddComment()">×</button>
          </div>

          <div class="popup-body add-comment-body">
            <!-- Tag -->
            <!-- <div class="form-group">
              <label class="form-label">Tag</label>
              <select
                class="select-input"
                [(ngModel)]="addCommentForm.tag"
                name="commentTag"
              >
                <option [ngValue]="null">Select</option>
                <option *ngFor="let t of commentTags" [ngValue]="t.value">
                  {{ t.label }}
                </option>
              </select>
            </div> -->

            <!-- Comment -->
            <div class="form-group">
              <label class="form-label">Comment</label>
              <textarea
                class="textarea-input"
                rows="6"
                placeholder="Text Here"
                [(ngModel)]="addCommentForm.notes"
                name="commentNotes"
              ></textarea>
            </div>

            <!-- Buttons -->
            <div class="add-comment-actions">
              <button
                class="btn btn-outline"
                type="button"
                (click)="cancelAddComment()"
              >
                CANCEL
              </button>
              <button
                class="btn btn-primary"
                type="button"
                (click)="submitAddComment()"
              >
                ADD
              </button>
            </div>
          </div>
        </div>

        <!-- ===================== Search + Filter Panel ===================== -->
        <div class="calender-escalated-section calender-third-section">
          <div class="search-wrapper">
            <input
              type="text"
              placeholder="Search here"
              [(ngModel)]="searchTerm"
              class="search-input"
              (input)="onFilterTextBoxChanged()"
            />

            <button
              type="button"
              class="filter-toggle-btn"
              (click)="openFilter()"
              aria-label="Open filters"
            >
              <img
                src="assets/filter-icon.png"
                alt="filter"
                class="filter-toggle-icon"
              />
            </button>
          </div>
        </div>

        <app-events-filter-panel
          *ngIf="isFilterOpen"
          [showDateRange]="selectedFilter === 'CLOSED'"
          [queuesChecked]="selectedFilter === 'PENDING' && queuesChecked"
          [cities]="cities"
         [sites]="filterLists.sites"
  [cameras]="filterLists.cameras"
          [actionTags]="actionTags"
  [eventTypes]="filterLists.eventTypes"
  [employees]="filterLists.userLevels"
  [consoleTypes]="filterLists.consoleTypes"
  [queues]="filterLists.queueNames"
  [queueLevels]="filterLists.queueLevels"
    (criteriaChange)="onFilterCriteriaChange($event)"

          [consolesChecked]="consolesChecked"
          [queuesChecked]="queuesChecked"
          [filter]="currentFilter"
          (close)="onFilterClose()"
          (reset)="onFilterReset()"
          (apply)="onFilterApply($event)"
          (consolesToggle)="onconsolesToggle()"
          (queuesToggle)="onqueuesToggle()"
        ></app-events-filter-panel>

        <!-- ===================== Centered Play Popup ===================== -->
        <p-overlayPanel
          #playOverlay
          [dismissable]="true"
          appendTo="body"
          styleClass="play-tooltip-left"
        >
          <div class="play-popup-content">
            <div class="play-popup-header">
              <div class="play-popup-header-content">
                <p class="play-text">{{ selectedPlayItem?.siteId }}</p>
                <p class="play-text1">
                  {{ selectedPlayItem?.siteName }} |
                  {{ selectedPlayItem?.cameraId }}
                </p>
              </div>

              <div class="play-popup-actions">
                <!-- Download all images -->
                <button
                  type="button"
                  class="icon-btn"
                  (click)="downloadAllImages($event)"
                  title="Download all images"
                >
                  <img
                    src="assets/Dounload.svg"
                    alt="download"
                    class="escalated-icon"
                  />
                </button>

                <!-- Open all images in new tabs -->
                <button
                  type="button"
                  class="icon-btn"
                  (click)="openAllImagesInNewTabs($event)"
                  title="Open all images in new tabs"
                >
                  <img
                    src="assets/expand.png"
                    alt="open in new tab"
                    class="escalated-icon"
                  />
                </button>

                <!-- Close popup -->
                <button
                  type="button"
                  class="icon-btn"
                  (click)="closePlayPopup()"
                  title="Close"
                >
                  <img
                    src="assets/close-filled-black.svg"
                    alt="close"
                    class="escalated-icon"
                  />
                </button>
              </div>
            </div>

            <div class="popup-body">
              <ng-container *ngIf="selectedPlayItem?.videoFile?.length; else noImages">
                <!-- <img
                              class="play-image"
                              [src]="getCurrentImageUrl()"
                              alt="Event image"
                            /> -->
            
            
            
                <ng-container *ngIf="getCurrentImageUrl() | image | async as imgUrl; else loading">
                  <img class="play-image" [src]="imgUrl" alt="Event frame" />
                </ng-container>
            
              </ng-container>
            
              <ng-template #loading>
                <!-- loader / blank / skeleton -->
                <div>Loading...</div>
              </ng-template>
            
              <ng-template #noImages>
                <p>No images available</p>
              </ng-template>
            </div>
          </div>
        </p-overlayPanel>

        <!-- ===================== Calendar Popup ===================== -->
        <div
          class="calendar-popup-overlay"
          *ngIf="isCalendarPopupOpen"
          (click)="closeCalendarPopup()"
        ></div>
        <div class="calendar-popup" *ngIf="isCalendarPopupOpen">
          <div class="popup-header">
            <h3>Calendar</h3>
            <button class="close-button" (click)="closeCalendarPopup()">
              ✖
            </button>
          </div>
          <div class="popup-content">
            <mat-calendar
              [(selected)]="selectedDate"
              (selectedChange)="onDateSelected($event)"
            ></mat-calendar>
          </div>
        </div>
      </div>

      <!-- ===================== Calendar Cards Section ===================== -->
      <div class="calender-section-body m-t-20">
        <div class="escalated-section calender-fifth-section">
          <div
            class="calender-escalated-card"
            *ngFor="let e of secondEscalatedDetails"
          >
            <div class="calender-escalated-card-content">
              <ng-container *ngIf="e.label; else nonLabelTemplate">
                <h4>{{ e.label }}</h4>
                <p [ngStyle]="{ color: e.color }">{{ e.value }}</p>
              </ng-container>

              <ng-template #nonLabelTemplate>
                <ng-container *ngIf="e.iconPath; else colorDotTemplate">
                  <img [src]="e.iconPath" alt="icon" class="escalated-icon" />
                  <p [ngStyle]="{ color: e.color }">{{ e.value }}</p>
                </ng-container>

                <ng-template #colorDotTemplate>
                  <div class="dot-item">
                    <div
                      class="dot"
                      [style.background-color]="e.iconcolor"
                    ></div>
                    <div class="dot-value">{{ e.value }}</div>
                  </div>
                </ng-template>
              </ng-template>
            </div>
          </div>
        </div>

        <div class="escalated-section calender-sixth-section"></div>

        <!-- More/Less toggle button -->
        <div class="escalated-section calender-seventh-section">
          <div class="more-less-toggle" (click)="toggleMore()">
            <button>
              <i [ngClass]="showMore ? 'arrow-up' : 'arrow-down'"></i>
              <span class="btn-text">{{ showMore ? "LESS" : "MORE" }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ===================== Expandable More Section ===================== -->
      <div class="m-t-20" *ngIf="showMore">
        <!-- CLOSED More Section -->
        <ng-container *ngIf="selectedFilter === 'CLOSED'">
          <div class="escalated-content-section">
            <ng-container
              *ngIf="escalatedDetailsClosed.length > 0; else noClosedData"
            >
              <div class="escalated-section-body">
                <div class="escalated-section first-section">
                  <div
                    class="escalated-card"
                    *ngFor="let e of escalatedDetailsClosed"
                  >
                    <div class="escalated-card-content">
                      <h4 class="labelmargin">{{ e.label }}</h4>
                      <h4 class="labelmargin">{{ e.value }}</h4>
                    </div>

                    <div class="icons">
                      <div class="dots-column" *ngIf="e.colordot">
                        <div
                          class="icon-section"
                          *ngFor="let dot of e.colordot"
                        >
                          <span
                            *ngIf="dot.iconcolor"
                            class="dot"
                            [ngStyle]="{ 'background-color': dot.iconcolor }"
                          ></span>
                          <span class="dot-count">{{ dot.count }}</span>
                        </div>
                      </div>

                      <div class="icons-group" *ngIf="e.icons">
                        <div class="icon-section" *ngFor="let icon of e.icons">
                          <img
                            [src]="icon.iconPath"
                            alt="icon"
                            class="icon-image"
                          />
                          <span>{{ icon.count }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #noClosedData>
              <div class="no-data-wrapper">No data available</div>
            </ng-template>
          </div>
        </ng-container>

        <!-- PENDING More Section -->
        <ng-container *ngIf="selectedFilter === 'PENDING'">
          <div class="escalated-content-section">
            <div class="escalated-section-body">
              <div class="escalated-section first-section">
                <div
                  class="escalated-card"
                  *ngFor="let e of escalatedDetailsPending"
                >
                  <div class="escalated-card-content">
                    <h4 class="labelmargin">{{ e.label }}</h4>
                    <h4 class="labelmargin">{{ e.value }}</h4>
                  </div>

                  <div class="icons">
                    <div class="dots-column" *ngIf="e.colordot">
                      <div class="icon-section" *ngFor="let dot of e.colordot">
                        <span class="dot-label">{{ dot.label }}</span>
                        <span class="dot-count">{{ dot.count }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- ===================== AG Grid Tables ===================== -->

      <!-- ===================== AG Grid Tables ===================== -->

      <!-- PENDING Table -->
      <div class="m-t-20" *ngIf="selectedFilter === 'PENDING'" >
        <div class="escalated-content-section">
          <div class="ag-grid-wrapper" >
            <ag-grid-angular
            style="height: 100%"
              theme="legacy"
              class="ag-theme-alpine"
              [rowData]="pendingDisplayRows"
              [columnDefs]="pendingColumnDefs"
              [defaultColDef]="defaultColDef"
              [pagination]="true"
              [paginationPageSize]="15"
              [rowHeight]="30"
              [headerHeight]="30"
              domLayout="autoHeight"
              [enableCellTextSelection]="true"
              [enableRangeSelection]="true"
              [copyHeadersToClipboard]="true"
              [quickFilterMatcher]="pendingQuickFilterMatcher"
              [paginationPageSizeSelector]="[15, 20, 50, 100]"
              (gridReady)="onGridReady($event)"
              [icons]="gridIcons"
              (cellClicked)="onCellClicked($event)"
              [statusBar]="statusBar"
              (firstDataRendered)="onFirstDataRendered()"
            >
            </ag-grid-angular>
          </div>
        </div>
      </div>

      <!-- CLOSED Table -->
      <div class="m-t-20" *ngIf="selectedFilter === 'CLOSED'">
        <div class="escalated-content-section">
          <ag-grid-angular
            theme="legacy"
            class="ag-theme-alpine"
            [rowData]="closedDisplayRows"
            [columnDefs]="closedColumnDefs"
            [defaultColDef]="defaultColDef"
            [pagination]="true"
            [enableCellTextSelection]="true"
            [enableRangeSelection]="true"
            [copyHeadersToClipboard]="true"
            [paginationPageSize]="15"
            [rowHeight]="30"
            [headerHeight]="30"
            [paginationPageSizeSelector]="[15, 20, 50, 100]"
            [localeText]="localeText"
            domLayout="autoHeight"
            [quickFilterMatcher]="closedQuickFilterMatcher"
            (gridReady)="onGridReady($event)"
            [icons]="gridIcons"
            (cellClicked)="onCellClicked($event)"
            [statusBar]="statusBar"
            (firstDataRendered)="onFirstDataRendered()"
          >
          </ag-grid-angular>
        </div>
      </div>

      <!-- ========= Hidden template for pagination toolbar (cloned into .ag-paging-panel) ========= -->

      <div
        #paginationControls
        class="pagination-controls"
        style="display: none"
      >
        <div class="legend-group">
          <div class="dot-eventwall"></div>
          <label class="event-wall-label">Event Console</label>
          <div class="dot-manualwall"></div>
          <label class="manual-wall-label">Manual Console</label>
          <!-- Timed-Out only for PENDING; we'll hide via TS for CLOSED -->
          <div class="dot-timedOutWallCount" data-type="timed"></div>
          <label class="timedOut-wall-label" data-type="timed">Timed-Out</label>
        </div>
        <div class="refresh-group">
          <button class="refreshbutton" type="button">
            <img
              src="assets/refresh-circle-sharp.svg"
              alt="icon"
              class="escalated-icon refresh-icon"
            />
            Refresh
          </button>
          <select class="refresh-interval-select" >
            <option value="1">1 min</option>
            <option value="5">5 min</option>
            <option value="10">10 min</option>
            <option value="15">15 min</option>
            <option value="30">30 min</option>
          </select>
        </div>
      </div>

      <!-- ========================================================================= -->
    </div>
  </div>
</div>
